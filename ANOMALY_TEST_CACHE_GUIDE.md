# 🚀 异动监控测试 & 分析缓存系统使用指南

## 📋 功能概述

本指南涵盖两个新功能：
1. **异动消息推送测试功能** - 用于验证异动通知系统
2. **股票分析结果永久缓存系统** - 提高开发效率，避免重复分析

---

## 🧪 一、异动消息推送测试

### 功能说明
- ✅ 在异动监控页面添加了"🧪 触发假数据异动"按钮
- ✅ 点击按钮会生成模拟异动事件
- ✅ 测试异动通知、分析师回调、UI显示等完整流程

### 使用步骤

1. **访问Web界面**
   ```
   http://localhost:8501
   ```

2. **进入异动监控页面**
   - 点击侧边栏"🚨 异动监控"

3. **触发测试异动**
   - 在"监控配置"区域找到"测试功能"
   - 点击"🧪 触发假数据异动"按钮
   - 系统会自动生成随机股票的异动事件

4. **观察测试结果**
   - 检查页面顶部是否出现异动提醒
   - 查看侧边栏异动历史记录
   - 观察控制台日志输出

### 测试数据范围

**支持的测试股票代码**：
- **美股**: AAPL, GOOGL, MSFT, TSLA
- **A股**: 000001, 600519, 920005

**测试异动类型**：
- 📈 上涨异动 (surge)
- 📉 下跌异动 (drop)

**异动参数**：
- 价格变化幅度: 0.11% - 5.0%
- 价格范围: 10 - 500 元
- 成交量: 10万 - 1000万股

### 验证要点

✅ **异动检测**: 假数据是否正确生成和检测  
✅ **数据存储**: 异动事件是否正确存储到Redis  
✅ **回调触发**: 异动分析师是否正确接收回调  
✅ **UI显示**: 异动提醒是否正确显示在页面上  
✅ **会话状态**: Streamlit会话状态是否正确更新  

---

## 📦 二、分析结果缓存系统

### 功能说明
- ✅ **永久缓存**: 开发阶段所有分析结果永久保存
- ✅ **按代码日期存储**: 支持按股票代码和分析日期精确缓存
- ✅ **自动缓存**: 分析完成后自动缓存结果
- ✅ **缓存管理**: 提供Web界面查看和管理缓存

### 缓存目录结构

```
data/analysis_cache/
├── 920005_2025-07-31.json      # 江龙船艇今日分析
├── 920005_2025-07-30.json      # 江龙船艇昨日分析
├── 000001_2025-07-03.json      # 平安银行历史分析
└── ...
```

### 使用方法

#### 1. 查看缓存管理页面

1. **访问缓存管理**
   - 在Web界面点击侧边栏"💾 缓存管理"

2. **查看缓存统计**
   - 总缓存数
   - 缓存大小
   - 股票数量
   - 缓存目录

3. **浏览缓存列表**
   - 按股票代码筛选
   - 按日期范围筛选
   - 查看文件大小和修改时间

#### 2. 已缓存的数据

**当前可用缓存**：
- `920005` (江龙船艇) - 2025-07-31, 2025-07-30
- `000001` (平安银行) - 2025-07-03  
- `UNKNOWN_ANALYSIS` - 2025-07-31 (历史分析数据)

#### 3. 手动缓存操作

在缓存管理页面可以：
- 🔍 **查看缓存详情**: 查看JSON格式的缓存内容
- 💾 **手动创建缓存**: 为指定股票创建测试缓存
- 📊 **统计分析**: 按股票查看缓存分布

### 缓存数据格式

**示例 - 920005江龙船艇缓存数据**:
```json
{
  "symbol": "920005",
  "analysis_date": "2025-07-31",
  "cached_time": "2025-07-31T18:35:06.272",
  "data": {
    "stock_symbol": "920005",
    "stock_name": "江龙船艇",
    "market_type": "A股",
    "market_analysis": {
      "current_price": 64.63,
      "price_change": "+2.35%",
      "trend": "上升趋势"
    },
    "fundamentals_analysis": {
      "industry": "船舶制造",
      "main_business": "特种船舶制造与海洋工程装备"
    },
    "investment_advice": {
      "recommendation": "谨慎买入",
      "target_price": 68.00,
      "confidence_level": 0.72
    }
  }
}
```

### API使用方式

**Python代码示例**:
```python
from tradingagents.utils.analysis_cache import (
    cache_analysis_result, 
    load_cached_analysis, 
    is_analysis_cached
)

# 检查缓存是否存在
if is_analysis_cached('920005', '2025-07-31'):
    # 加载缓存数据
    cached_data = load_cached_analysis('920005', '2025-07-31')
    print("从缓存加载:", cached_data['data']['stock_name'])
else:
    # 执行新分析
    analysis_result = perform_analysis('920005')
    # 缓存结果
    cache_analysis_result('920005', analysis_result, '2025-07-31')
```

---

## 🔧 三、开发建议

### 缓存策略

**开发阶段（当前）**:
- ✅ 永久缓存所有分析结果
- ✅ 便于调试和测试
- ✅ 避免重复API调用

**生产阶段（未来）**:
- 📅 设置缓存过期时间（如7天）
- 🔄 定期清理旧缓存
- ⚡ 实时数据优先级更高

### 最佳实践

1. **测试异动推送**
   - 定期点击测试按钮验证功能
   - 观察日志输出确认流程正常
   - 测试不同市场股票代码

2. **利用缓存系统**
   - 优先检查缓存再进行新分析
   - 定期查看缓存管理页面
   - 手动清理无用的测试缓存

3. **数据管理**
   - 保留重要股票的历史分析
   - 及时缓存新的分析结果
   - 监控缓存目录大小

---

## 📊 四、运行状态检查

### 检查Web应用状态
```bash
# 检查进程
ps aux | grep streamlit

# 检查端口
curl -s "http://localhost:8501/healthz"

# 查看日志
tail -20 logs/tradingagents.log
```

### 检查缓存目录
```bash
# 查看缓存文件
ls -la data/analysis_cache/

# 检查缓存大小
du -sh data/analysis_cache/

# 查看缓存内容示例
cat data/analysis_cache/920005_2025-07-31.json | jq .
```

---

## 🎯 五、验证清单

### 异动推送测试验证

- [ ] Web应用正常启动 (http://localhost:8501)
- [ ] 异动监控页面可以访问
- [ ] "🧪 触发假数据异动"按钮可见
- [ ] 点击按钮后显示成功消息
- [ ] 页面刷新后显示异动提醒
- [ ] 控制台日志显示异动检测记录

### 缓存系统验证

- [ ] 缓存管理页面可以访问
- [ ] 显示正确的缓存统计信息
- [ ] 可以看到920005的缓存数据
- [ ] 筛选功能正常工作
- [ ] 可以查看缓存详情
- [ ] 手动创建缓存功能正常

---

## 🚀 总结

✅ **异动推送测试功能已就绪**
- 可以随时测试异动通知系统
- 验证完整的异动处理流程
- 支持多种市场股票代码

✅ **分析缓存系统已部署**
- 920005江龙船艇数据已缓存
- 支持永久存储开发数据
- 提供完整的管理界面

🎯 **立即开始测试**：
1. 访问 http://localhost:8501
2. 点击"🚨 异动监控" → 测试异动推送
3. 点击"💾 缓存管理" → 查看分析缓存

准备好了！您可以开始验证这两个功能了！🎉